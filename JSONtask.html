<!DOCTYPE HTML>
<html>
	<head>
		<link rel="stylesheet" href="styles.css" style="text/css">
	</head>
	<body>
		<textarea id="dataEntry" placeholder="Enter a IIIF canvas"></textarea>
		<button id="dataButton">Handle url or json</button>
		<div class="rowContainer">
			<span id="imgBoxx" class="rowItem"></span>
			<span id="textBoxx" class="rowItem"></span>
		</div>
		
	
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>

		<script>

		var $textField = $("#dataEntry");
		$textField.on("textSubmit", function () {
			evaluateData($textField.val());
		});
		
		var $textButton = $("#dataButton");
		$textButton.on("click", function () {
			$textField.trigger("textSubmit");
		});
		
		var $curCont = $("#textBoxx");
		var $curImg = $("#imgBoxx");
		var curTextLine = "";
		var lastURL = "";

		//Handles errors
		window.addEventListener('error',function(e){
		console.log(e)}, true);

		//Handles the storage of information
		var storageHandler = function(unstoredObject){
			curTextLine += unstoredObject;
		}
		
		//Checks objects from the canvas 
		var basicCheck = function(canvasObject){
			for (n in canvasObject){
				//if (canvasObject.hasOwnProperty(n)){
					if (Array.isArray(canvasObject[n]) || typeof(canvasObject[n]) == 'object'){
						switch(Array.isArray(canvasObject[n])){
							case true:	
								curTextLine += n + ":(Array)";
								textline(curTextLine);
								multipleObjectHelper(canvasObject[n]);
								curTextLine += "(/Array)";
								<!-- curTextLine +=("<br />");				 -->
								textline(curTextLine, 1);
								break;
							
							case false:
								curTextLine += n + ":(Object, containing:)";
								textline(curTextLine);
								multipleObjectHelper(canvasObject[n]);
								curTextLine += "(/Object)";
								<!-- curTextLine +=("<br />");				 -->
								textline(curTextLine, 1);
						
						}			
					} else if (validChecker(canvasObject[n]) == true){
						storageHandler(n);
						curTextLine +=": ";
						storageHandler(canvasObject[n]);
						textline(curTextLine);
						<!-- curTextLine +=("<br />"); -->
					}
				//}
			}
		};
		
	


		var validChecker = function(objectValue){
			if (objectValue == null){
				return false;
			}

			else if (typeof objectValue === 'string'){
				<!-- objectValue.trim(); -->
				if (objectValue.length > 0){
					if (objectValue.substring(0, 4) === "http") {
						handleURL(objectValue);
					}
					return true;
				}
			}
			else if (typeof objectValue === 'number'){
				if (objectValue > -1){
					return true;
				}
			}
			else if (typeof objectValue === 'boolean'){
				return true;
			}
		};
			
		var multipleObjectHelper = function(multiObject){
			switch(Array.isArray(multiObject)){
				case true:
					//Add the name of the array + "(Array)"
					for (var n=0; n<multiObject.length; n++){
						basicCheck(multiObject[n]);
					}
					//Add the name of the array, + "(/Array)"
					break;
						
			
				case false:
					//Add the name of the object, + "(Object, containing:)"
					basicCheck(multiObject);
					//Add the name of the object, + "(/Object)"
					break;
			}
		};
		



		//Parses the canvas in order to obtain necessary data for redrawing the canvas
		//How information will be parsed depends on the type of canvas
		var canvasParser = function(jsontext){
			<!-- var text = canvas.responseText; -->
			var parsedCanv = JSON.parse(jsontext);
			console.log(parsedCanv);
			var type = parsedCanv["@type"];
			basicCheck(parsedCanv);
		};



		var resolveCanvasURL = function (url) {
			clearArea();
			var aThing = $.getJSON(url, function() {
					alert("Image successfully obtained.");
				}
			).done( function() {
				canvasParser(aThing.responseText);
				}
			).fail( function() {
				alert("A problem has been found. Cannot display image.");
				}
			);
		};
		
		var evaluateData = function (text) {
			if (isURL(text)) {
				resolveCanvasURL(text);
			} else {
				resolveJSON(text);
			}
		};
		
		var isURL = function (text) {
			if (text.substring(0, 4) == "http") {
				return true;
			} else {
				return false;
			}
		};
		
		
		//	HTML STUFF====================================================
		var handleURL = function (url) {
			//test if url first (basic test)
			var result = isURL(url);
			if (result) {
				var rexp = /\.jpg/i;
				if (rexp.test(url)) {
					if (url == lastURL) {
						return;
					} else {
						lastURL = url;
					}
					resolveImage(url);
				} else {
					alert("Found a URL, but could not identify it!");
					console.log(url);
				}
			}	
		};
		
		var resolveImage = function (imgUrl) {
			var img = $("<img src='" + imgUrl + "' />");
			img.on("load", function () {
				//TODO: display the image somewhere here!
				console.log("attempt image append");
				$curImg.append(img);
				
			});
		};
		
		var resolveJSON = function (text) {
			clearArea();
			canvasParser(text);
		};
		
		var textline = function (text, bool) {
			if (bool){
				var para = "<p class='colorChange'>"
			}
			else{
			var para = "<p>";
			}
			$curCont.append(para + text + "</p>");
			curTextLine = "";
		};
		
		var clearArea = function () {
			$curCont.empty();
			$curImg.empty();
			curTextLine = "";
			lastURL = "";
		};

		//Some tests, to be deleted later
		var exampleCanv = "http://165.134.241.141/annotationstore/annotation/55f9da84e4b04dde25a2734c";
		evaluateData(exampleCanv);
		


	
		</script>
	</body>

</html>

